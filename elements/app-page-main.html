<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-icons/iron-icons.html">
<link rel="import" href="../../iron-icons/hardware-icons.html">
<link rel="import" href="../../iron-icons/editor-icons.html">
<link rel="import" href="../../iron-pages/iron-pages.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../paper-menu/paper-menu.html">
<link rel="import" href="../../paper-item/paper-item.html">
<link rel="import" href="import-jquery.html">
<link rel="import" href="global-variable.html">
<link rel="import" href="list-remote.html">
<link rel="import" href="list-device.html">
<link rel="import" href="dialog-remote.html">

<dom-module id="app-page-main">
  <style>
    #left {
      box-shadow: rgba(0, 0, 0, 0.098) 0px 2px 4px,
                  rgba(0, 0, 0, 0.098) 0px 0px 3px;
    }
  </style>

  <template>
    <global-variable id="global" key="page-main"></global-variable>
    <global-variable key="main" value="{{main}}"></global-variable>
    <global-variable key="page-remote" value="{{pageRemote}}"></global-variable>

    <dialog-remote id="dialog-remote" on-accept="onAcceptRemoteDialog"></dialog-remote>

    <paper-drawer-panel>
      <paper-header-panel id="left" drawer>
        <paper-toolbar>
          <div>Menu</div>
        </paper-toolbar>
        <paper-menu selected="{{page}}" attr-for-selected="name">
          <paper-item name="remotes">Remotes</paper-item>
          <paper-item name="devices">Devices</paper-item>
          <hr/>
          <paper-item name="settings">Settings</paper-item>
          <paper-item name="about">About</paper-item>
        </paper-menu>
      </paper-header-panel>

      <iron-pages selected="{{page}}" attr-for-selected="name" main>
        <div name="remotes">
          <paper-header-panel>
            <paper-toolbar>
              <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
              <div class="title">Remotes</div>
              <paper-icon-button icon="add-circle" on-click="onNew"></paper-icon-button>
            </paper-toolbar>
          </paper-header-panel>
          <div class="page">
            <list-remote id="list-remote" on-open="onOpen" on-edit="onEdit" on-remove="onRemove"></list-remote>
          </div>
        </div>
        <div name="devices">
          <paper-header-panel>
            <paper-toolbar>
              <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
              <div class="title">Devices</div>
              <paper-spinner active></paper-spinner>
            </paper-toolbar>
          </paper-header-panel>
          <div class="page">
            <list-device id="list-device"></list-device>
          </div>
        </div>
        <div name="settings">
          <paper-header-panel>
            <paper-toolbar>
              <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
              <div class="title">Settings</div>
            </paper-toolbar>
          </paper-header-panel>
        </div>
      </iron-pages>
    </paper-drawer-panel>
  </template>
</dom-module>

<script>
  Polymer({
    is: "app-page-main",
    properties: {
      page: {
        type: String,
        notify: true,
        value: "remotes"
      }
    },
    ready: function() {
      this.$.global.value = this;
    },
    onOpen: function(event) { this.open(event.detail); },
    onEdit: function(event) { this.openRemoteDialog(event.detail); },
    onRemove: function(event) { this.remove(event.detail); },
    onNew: function() { this.openRemoteDialog(null); },
    open: function(remote) {
      $("#remote-title").text(remote.name);

      this.main.page = "remote";

      this.pageRemote.load(remote);
      this.pageRemote.setEditable(false);
    },
    remove: function(remote) {
      var index = $.inArray(remote, ir.remote.remotes);
      ir.remote.remotes.splice(index, 1);
    },
    openRemoteDialog: function(remote) {
      var dialog = this.$["dialog-remote"];

      // TODO: get rid of this stuff; just use .open(remote)
      dialog.set(remote);
      dialog.remote = remote;
      dialog.open();
    },
    onAcceptRemoteDialog: function() {
      var dialog = this.$["dialog-remote"];
      var remote = dialog.remote ? dialog.remote : {};

      dialog.get(remote);
      // TODO: outsource default gridster config
      $.extend(remote, {
        ui: {
          type: "grid",
          settings: {
            base_margin: [5, 5],
            base_dimension: [50, 50]
          },
          buttons: []
        }
      });

      if (!dialog.remote) ir.remote.remotes.push(remote);

      dialog.close();
    }
  });
</script>
