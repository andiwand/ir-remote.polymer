<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../import-jquery/import-jquery.html">
<link rel="import" href="import-pagejs.html">

<script>
  Polymer({
    is: "app-routing",
    properties: {
      switch: { type: String, observer: "_onSwitchChange" },
      value: { type: Object, notify: true, readOnly: true },
      params: { type: Object, notify: true, readOnly: true },
    },
    _onSwitchChange: function(newValue, oldValue) {
      if (oldValue) ir.ui.routing.deregister(oldValue, this);
      if (!this.switch) return;
      ir.ui.routing.register(this.switch, this);
    },
    _onVisit: function(path, ctx) {
      this.fire("visit", {
        router: this,
        path: path,
        swtch: this.switch,
        value: this.value,
        params: this.params,
        ctx: ctx
      });
    }
  });
</script>

<script>
  var ir = ir || {};
  ir.ui = ir.ui || {};
  ir.ui.routing = ir.ui.routing || {
    switches: {},
    mapping: {},
    init: function(base) {
      page.start({ hashbang: true });
      page.base(base);
    },
    register: function(swtch, router) {
      this.switches[swtch] = this.switches[swtch] || [];
      this.switches[swtch].push(router);
    },
    deregister: function(swtch, router) {
      if (!(swtch in this.switches)) return;
      this.switches[swtch] = $.grep(this.switches[swtch], function(v) {
        return v !== router;
      });
    },
    fire: function(path, swtch, value, ctx) {
      $.each(this.switches[swtch], function(i, v) {
        v._setValue(value);
        v._setParams(ctx.params);
        v._onVisit(path, ctx);
      });
    },
    open: function(path) {
      page.show(path);
    },
    map: function(path, switching) {
      if (!"swtch" in switching) throw new Error();

      this.mapping[path] = switching;

      page(path, $.proxy(function(ctx) {
        this.callback(path, ctx);
      }, this));
    },
    mapAll: function(mappings) {
      $.each(mappings, $.proxy(function(k, v) {
        this.map(k, v);
      }, this));
    },
    callback: function(path, ctx) {
      $.each(this.mapping[path], $.proxy(function(i, v) {
        this.fire(path, v.swtch, v.value, ctx);
      }, this));
    }
  };

  (function() {
    routing = ir.ui.routing;

    routing.init("/components/ir-remote.polymer/test/");

    routing.mapAll({
      "/": [
        { swtch: "main", value: "root" },
        { swtch: "root", value: "remotes" }
      ],
      "/remotes": [
        { swtch: "main", value: "root" },
        { swtch: "root", value: "remotes" }
      ],
      "/devices": [
        { swtch: "main", value: "root" },
        { swtch: "root", value: "devices" }
      ],
      "/settings": [
        { swtch: "main", value: "root" },
        { swtch: "root", value: "settings" }
      ],
      "/about": [
        { swtch: "main", value: "root" },
        { swtch: "root", value: "about" }
      ],
    });
  })();
</script>
